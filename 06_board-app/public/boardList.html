t<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>게시글 목록</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container list-container">
      <div class="header-group">
        <h2>게시글 목록</h2>
        <button type="button" id="btn-write" class="btn-write">
          새 글 작성
        </button>
      </div>

      <table class="board-table">
        <thead>
          <tr>
            <th>번호</th>
            <th>제목</th>
            <th>작성자</th>
            <th>작성일시</th>
          </tr>
        </thead>
        <tbody id="boardList">
          <tr>
            <td colspan="4" style="text-align: center">
              데이터를 불러오는 중...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // querySelector(".btn-write") 대신 #id로 선택
        const writeBtn = document.querySelector("#btn-write");

        if (writeBtn) {
          // 기존 이벤트를 확실히 덮어쓰기 위해 onclick을 직접 제어해봅시다
          writeBtn.onclick = (e) => {
            const token = localStorage.getItem("token");
            console.log("현재 토큰 상태:", token); // 확인용 로그

            if (!token || token === "null" || token === "undefined") {
              alert("로그인이 필요한 서비스입니다.");
              location.href = "/login.html";
              return false; // 이동 방지
            }

            location.href = "/board.html";
          };
        }
      });
      const list = async () => {
        const parent = document.querySelector("#boardList");

        try {
          const result = await fetch("/api/board/", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!result.ok) {
            throw new Error("서버 응답 에러");
          }

          const data = await result.json();
          let boardArray = [];
          if (Array.isArray(data)) {
            boardArray = data;
          } else if (data && Array.isArray(data.data)) {
            boardArray = data.data;
          }
          parent.innerHTML = "";

          if (boardArray.length === 0) {
            parent.innerHTML =
              '<tr><td colspan="4" style="text-align:center;">게시글이 없습니다.</td></tr>';
            return;
          }

          for (let board of boardArray) {
            const { board_id, title, name, created_at } = board;

            const dateText = created_at
              ? new Date(created_at).toLocaleString()
              : "날짜없음";

            const html = `
        <tr>
          <td>${board_id}</td>
          <td class="text-left">
            <a href="boardDetail.html" data-page="${board_id}">${title}</a>
          </td>
          <td>${name}</td>
          <td>${dateText}</td>
        </tr>`;

            parent.insertAdjacentHTML("beforeend", html);
          }

          const anchors = document.querySelectorAll("tbody a");
          anchors.forEach((ele) => {
            ele.addEventListener("click", (e) => {
              e.preventDefault();

              const pageId = e.currentTarget.dataset.page;
              localStorage.setItem("page", pageId);
              location.href = "boardDetail.html";
            });
          });
        } catch (err) {
          console.error("목록 출력 중 에러발생:", err);
          parent.innerHTML =
            '<tr><td colspan="4" style="text-align:center; color:red;">데이터를 불러올 수 없습니다.</td></tr>';
        }
      };

      list();
    </script>
  </body>
</html>
